

# Technical Specification: Distributed Offline-First Finance System

| Metadata | Details |
| :--- | :--- |
| **Project Name** | Katering Haramain Finance (MVP) |
| **Version** | 1.0.0 (Draft) |
| **Architecture** | Local-First (Electron Sidecar Pattern) |
| **Date** | December 8, 2025 |

---

## 1. Executive Summary
Sistem ini adalah aplikasi keuangan desktop multi-cabang yang mengutamakan **ketersediaan lokal (Local-First)**. Aplikasi harus berfungsi 100% tanpa koneksi internet untuk input data, dashboard, dan laporan. Sinkronisasi data ke server pusat dilakukan secara otomatis di latar belakang (background process) ketika koneksi internet tersedia.

---

## 2. High-Level Architecture

Sistem menggunakan pola **"Sidecar Backend"**:
1.  **Electron** menjalankan Frontend (React) dan Backend Lokal (Go Binary).
2.  **React** hanya berbicara dengan **Go Lokal**.
3.  **Go Lokal** berbicara dengan **Go Cloud** untuk sinkronisasi.

### Diagram Alur Data

```mermaid
graph LR
    subgraph "Local User Environment (Offline Capable)"
        FE[React Frontend] -- HTTP JSON --> L_API[Local Go API]
        L_API -- SQL --> L_DB[(SQLite DB)]
        L_API -- Background Sync --> C_API
    end

    subgraph "Cloud Infrastructure (Dockerized)"
        C_API[Cloud Go API] -- SQL --> C_DB[(PostgreSQL DB)]
    end
````

-----

## 3\. Technology Stack & Versions

### 3.1 Frontend (Desktop Renderer)

  * **Runtime:** Electron (Latest Stable)
  * **Framework:** React v18+ + Vite v5+
  * **Language:** TypeScript
  * **State/Data Fetching:** TanStack Query (React Query) v5 -\> *Critical untuk caching data lokal.*
  * **UI Component:** Shadcn/UI + Tailwind CSS
  * **Charting:** Recharts
  * **IPC Communication:** HTTP Request ke Localhost (Bukan IPC native Electron agar lebih decouple).

### 3.2 Backend (Local & Cloud Shared Codebase)

  * **Language:** Go (Golang) v1.22+
  * **Web Framework:** Fiber v2 (High Performance)
  * **ORM:** GORM (Mendukung driver SQLite & Postgres sekaligus).
  * **Migration:** Golang-migrate atau GORM AutoMigrate (Strict Mode).
  * **Logging:** Zerolog (Structured Logging).

### 3.3 Database

  * **Local (Client):** SQLite3 (File based).
  * **Cloud (Server):** PostgreSQL 15 (Dockerized).

### 3.4 Infrastructure

  * **Container:** Docker & Docker Compose.
  * **Reverse Proxy:** Nginx (Optional di Cloud).

-----

## 4\. Coding Rules & Conventions (STRICT)

Untuk menjaga konsistensi kode dan mencegah "Spaghetti Code":

1.  **Architecture Pattern:** Gunakan **Clean Architecture** atau **Repository Pattern**.
      * `Handler` (HTTP Layer) -\> `Service` (Business Logic) -\> `Repository` (DB Access).
      * *Dilarang* melakukan query database langsung di dalam Handler.
2.  **Naming Convention:**
      * **Go Structs:** `PascalCase` (e.g., `TransactionRequest`).
      * **JSON Response:** `snake_case` (e.g., `total_amount`).
      * **Database Columns:** `snake_case` (e.g., `created_at`).
      * **Variables:** `camelCase`.
3.  **ID Generation:**
      * **WAJIB** menggunakan **UUID v4** untuk Primary Key semua tabel transaksi.
      * *Alasan:* Mencegah tabrakan ID (collision) saat sinkronisasi data dari banyak cabang ke satu server pusat.
4.  **Error Handling:**
      * Backend harus me-return HTTP Code yang tepat (200, 400, 401, 500).
      * Response format standar:
        ```json
        {
          "success": false,
          "message": "Error description",
          "data": null
        }
        ```
5.  **Git Flow:**
      * `main`: Production ready.
      * `dev`: Development branch.
      * `feat/nama-fitur`: Branch pengerjaan fitur.

-----

## 5\. Database Schema

### 5.1 Tabel `branches` (Cabang)

*Penyimpanan master data cabang.*
| Column | Type | Constraint | Note |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PK | Generated by System |
| `code` | VARCHAR(10) | UNIQUE | e.g., "JKT-01" |
| `name` | VARCHAR(100) | NOT NULL | Nama Cabang |
| `api_key` | VARCHAR(255) | NOT NULL | Token autentikasi sinkronisasi |

### 5.2 Tabel `transactions` (Transaksi)

*Tabel utama pencatatan.*
| Column | Type | Constraint | Note |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PK | **Generate di Local** |
| `branch_id` | UUID | FK | ID Cabang User |
| `type` | VARCHAR(10) | NOT NULL | `IN` (Masuk) or `OUT` (Keluar) |
| `category` | VARCHAR(50) | NOT NULL | e.g., Operasional, Bahan Baku |
| `amount` | BIGINT | NOT NULL | Gunakan Integer, jangan Float |
| `description` | TEXT | | |
| `created_at` | TIMESTAMP | DEFAULT NOW | Waktu input |
| **`is_synced`** | BOOLEAN | DEFAULT FALSE | **Penanda Sync** (Hanya di SQLite) |
| `synced_at` | TIMESTAMP | NULL | Waktu sukses upload |

-----

## 6\. API Specification

### 6.1 Local API (Consumed by React)

Endpoint ini berjalan di `localhost:8080`.

  * **Input Transaksi**
      * `POST /api/v1/transactions`
      * Body: `{ type, amount, category, description }`
      * *Action:* Simpan ke SQLite, set `is_synced=false`.
  * **Get Dashboard Stats**
      * `GET /api/v1/dashboard/summary`
      * *Action:* Query SQLite `SUM(amount)` group by `type`.
  * **Get Transaction List**
      * `GET /api/v1/transactions?page=1&limit=10`
  * **Check Sync Status**
      * `GET /api/v1/system/status`
      * Response: `{ unsynced_count: 5, status: "online/offline" }`

### 6.2 Cloud API (Consumed by Go Local)

Endpoint ini berjalan di Server VPS.

  * **Sync Push (Upload)**
      * `POST /api/v1/sync/push`
      * Header: `Authorization: Bearer <BRANCH_API_KEY>`
      * Body: `[{ transaction_data_array }]`
      * *Action:* Validasi, Insert ke Postgres (Ignore jika ID sudah ada).

-----

## 7\. Synchronization Logic (Core Feature)

Logika ini berjalan sebagai **Goroutine (Background Worker)** di Go Local.

**Algoritma Sync:**

1.  **Interval:** Jalankan setiap 30 detik.
2.  **Fetch Local:** Query SQLite:
    `SELECT * FROM transactions WHERE is_synced = 0 LIMIT 50`
3.  **Check Empty:** Jika data kosong, `return`.
4.  **Network Call:** Kirim data ke Cloud API (`POST /sync/push`).
5.  **Handle Response:**
      * **Success (200):** Update SQLite: `UPDATE transactions SET is_synced = 1 WHERE id IN (...)`
      * **Fail (Network Error):** Log error, jangan ubah status data (akan dicoba lagi di interval berikutnya).
      * **Fail (Data Invalid):** Tandai error di lokal agar user tahu ada data bermasalah.

-----

## 8\. Deployment Configuration (Docker)

File ini digunakan untuk mendeploy **Cloud Backend**.

### `Dockerfile`

```dockerfile
# Build Stage
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
# Build binary untuk Linux Server
RUN CGO_ENABLED=0 GOOS=linux go build -o server_binary ./cmd/cloud/main.go

# Run Stage
FROM alpine:latest
WORKDIR /root/
COPY --from=builder /app/server_binary .
COPY .env .
EXPOSE 3000
CMD ["./server_binary"]
```

### `docker-compose.yml`

```yaml
version: '3.8'

services:
  # Database Pusat
  postgres_db:
    image: postgres:15-alpine
    container_name: shohsa_finance_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: shosha_finance
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Backend API Pusat
  go_backend:
    build: .
    container_name: shosha_finance_api
    restart: always
    ports:
      - "3000:3000"
    environment:
      DB_HOST: postgres_db
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_NAME: kh_finance
      DB_PORT: 5432
    depends_on:
      - postgres_db

volumes:
  pg_data:
```

-----

## 9\. Web/Application Flow

### Skenario: Kasir Input Pengeluaran (Offline)

1.  **Start:** Kasir membuka aplikasi "Shosha Finance".
2.  **Init:** Electron menjalankan `backend.exe` di background (port 8080).
3.  **UI:** Kasir melihat Dashboard (React me-load data dari SQLite via localhost).
4.  **Action:** Kasir klik menu "Pengeluaran" -\> Input "Beli Gas 3kg" -\> Rp 20.000 -\> Klik Simpan.
5.  **Process:**
      * React POST ke `localhost:8080`.
      * Go generate UUID, simpan ke SQLite dengan `is_synced = false`.
      * Go return `200 OK`.
6.  **Feedback:** Layar Kasir langsung muncul notif "Berhasil". Saldo Kas berkurang instan.

### Skenario: Sistem Melakukan Sinkronisasi (Otomatis)

1.  **Background:** 30 detik kemudian, Go Worker bangun.
2.  **Check:** Go mendeteksi ada 1 data `is_synced = false` (Data Gas tadi).
3.  **Ping:** Go ping ke `google.com` -\> Sukses (Internet Ada).
4.  **Upload:** Go kirim data Gas ke Cloud Server.
5.  **Finish:** Cloud Server terima dan simpan ke Postgres. Cloud balas `OK`.
6.  **Update Local:** Go update data Gas di SQLite jadi `is_synced = true`.

<!-- end list -->


---

### Langkah Selanjutnya

Dokumen ini sudah mencakup **Arsitektur, Coding Rules, Schema, API, dan Deployment**.

Apakah Anda ingin saya buatkan **Project Setup** (folder structure & inisialisasi `go mod`) agar Anda bisa langsung mulai coding berdasarkan Tech Spec ini?
```